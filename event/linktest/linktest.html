<!--
   EMULAB-COPYRIGHT
   Copyright (c) 2000-2005 University of Utah and the Flux Group.
   All rights reserved.
  -->
<center>
<h1>Linktest Tutorial</h1>
</center>

<em>Linktest is an online validation test of the network characteristics
in an Emulab experiment.  It's a check that Emulab set up the network
as you requested.  If you care about the fidelity of your network, you
should set linktest to run on all or some swapins, and you should read
this entire tutorial.</em>


<h2>Contents</h2>
<ul>
<li> <a href="#QuickStart">Quick Start</a>
<li> <a href="#Limits">Limitations</a>
<li> <a href="#Understand">Understanding Linktest</a>
    <ul>
    <li> <a href="#Level0">Level 0 - Do not run Linktest</a>
    <li> <a href="#Level1">Level 1 - Connectivity and Latency</a>
    <li> <a href="#Level2">Level 2 - Static Routing</a>
    <li> <a href="#Level3">Level 3 - Loss</a>
    <li> <a href="#Level4">Level 4 - Bandwidth</a>
    </ul>
<li> <a href="#Advanced">Advanced Topics</a>
    <ul>
    <li> <a href="#Web">Running Linktest from the Web Interface</a>
    <li> <a href="#Ops">Running Linktest on Ops</a>
    <li> <a href="#Log">Linktest Log Directory</a>
    </ul>
</ul>

<hr>
<a name="QuickStart"></a>
<center>
<h2>Quick Start</h2>
</center>

<em>
Temporarily, while we are validating and tuning linktest,
on every swapin or modify:<br>
(1) We ignore users' requests to set the linktest level below 3;
i.e., we always run linktest, at level 3 or greater.<br>
(2) Although the activity log still reports all linktest results, including
failures, we email failures only to testbed-ops, not the user.<br>
(If you <a href = "#Advanced">explictly invoke linktest</a>
from the "Run Linktest" page or on ops, you get whatever level you request.)
</em>

<p>
To run linktest, select a Linktest test level from the dropdown on the
<a href="beginexp_html.php3">Begin an Experiment</a> page.
<ul>
<li> <a href="#Level1"><b>Level 1</b> - Connectivity and Latency</a>:
     For fastest response, select level 1.  Through ping, this will check
     link-level connectivity and link latencies.
<br>
<li> <a href="#Level2"><b>Level 2</b> - Plus Static Routing</a>:
     In addition to the above, tests static routing (if applicable).
<br>
<li> <a href="#Level3"><b>Level 3</b> - Plus Link Loss</a>: Check link loss
     characteristics.  Test levels are cumulative, so this option also
     includes connectivity, latency, and static routing (if applicable).
<br>
<li> <a href="#Level4"><b>Level 4</b> - Plus Bandwidth</a>: If bandwidth is
     important in your experiment, select level 4.  Be warned that the
     bandwidth test takes up to 20 seconds per link.  <b>Also note that
     not all bandwidths can be accurately measured</b>. If that
     happens, a warning will be placed in the log file for each link
     that is out of range for bandwidth testing. 
</ul>
<p>
If you select a test level other than zero, Linktest will run
after the experiment completes its swapin. If a problem is found,
testbed-ops is automatically notified and a message will appear in the
activation log. You will also receive an email message to ensure that
you are aware of the problem. Otherwise, no notification will
appear. A failure in linktest will <em><b>not</b></em> cause the
swapin to fail!</em> If traffic shaping parameters are of critical
importance to your experiments, make sure you take a closer look if
linktest reports failures! 
</p>

<hr>
<a name="Limits"></a>
<center>
<h2>Limitations (Important, Please Read)</h2>
</center>

<ul>
<li> Not all bandwidths can be accurately measured, and linktest <a href="#Level4">will
     skip links</a> that it knows will give false results (e.g., slow or lossy links).
     Please check the output, and be sure to test those links yourself if your
     results depend on total accuracy.

<li> As with any automated testing procedure, we have to balance the desire
     for accuracy with the possibility of false positives. To reduce
     the number of false positives, we allow for a small amount of
     fudge on any link. <b>If your results are dependent on total
     accuracy, then you should test your links yourself!</b>

<li> When using "endnodeshaping" (so-called linkdelays), latency is less accurate
     because of the 1ms clock resolution at which the kernel runs. At
     worst, latency can be off by up to 3ms, say for a roundtrip ping
     packet.

<li> Linktest can take a <b>long time</b> on large experiments. Even
     on very small experiments (5-10 nodes), doing the full bandwidth test
     can add 2-3 minutes. You should probably <em>not</em> do bandwidth
     tests at swapin on any experiment over 20 nodes unless you are
     prepared to wait a <em>long</em> time for the experiment to swap
     in. If you decide you have waited long enough, you can use the
     <b>Stop Linktest</b> menu option on the Show Experiment page. This
     will cancel linktest and allow the swapin to complete normally.
 
</ul>
</center>


<hr>
<a name="Understand"></a>
<center>
<h2>Understanding Linktest</h2>
</center>

<p>
Linktest is an end-to-end validation test for Emulab experiments. It
verifies that experiment nodes are up, that they are reachable by
static routes (when applicable), and that traffic shaping on delay
nodes matches the experiment NS script.
</p>

<p>
Linktest works by reading a data file of all of the links and their
attributes, and then invoking external measurement tools -- namely
ping, <a href="http://rude.sourceforge.net">Rude and Crude</a> and <a
href=http://dast.nlanr.net/Projects/Iperf/>iperf</a>.  Linktest
compares the results against margins of error calculated in advance to
identify major errors in configuration.
</p>

<p>
Linktest runs on each experiment node. The Linktest daemon waits for a
custom event instructing it to begin testing. When it receives the
event, it invokes the Linktest script to conduct the actual tests. The
script invokes external processes to validate links and log any errors
found.  If a node detects an error, it writes an explanatory message
to the experiment tbdata/linktest directory. Otherwise, no messages
appear in the directory after Linktest completes its run.

</p>
<p>
Linktest uses test levels to select which tests to perform. Test
levels are cumulative, so that selecting a higher test level ensures
lower-level tests are also run. Test levels are ordered in length of
time to complete, so that <a href="#Level4">Level 4 - Bandwidth</a>
takes the most time and
<a href="#Level1">Level 1 - Connectivity and Latency</a> takes the least.
</p>
<p>
Read more about each test level in the following sections:
</p>
<ul>
<a NAME="Level0"></a>
<li> <h3>Level 0 - Do not run Linktest</h3>

<p>
The default test level is Level 0 - Do not run Linktest. Use this
level to leave Linktest turned off, performing no validation of
experiment links after swapin.
</p>

<a NAME="Level1"></a>
<li> <h3>Level 1 - Connectivity and Latency</h3>

<p>
Each Linktest node on a lan or direct link pings the node on the other
side of the link. From the responses, the node detects whether the
link is up and the latency of the link. Linktest compares the measured
latency with the expected latency of the link, adjusting for known
delay crossing the testbed backplane. If the measured latency
is outside the 99% confidence interval for latencies at that setting,
Linktest reports an error.
</p>

<p>
<b>Note:</b> In an effort not to get bogged down by reporting too many
false positive errors, Linktest will look at the actual delta and
report an error only if the measured latency is more then 0.5
millseconds <em>below</em> the desired value, or more than 3.5
millseconds <em>above</em> the desired value.
</p>

<a NAME="Level2"></a>
<li> <h3>Level 2 - Static Routing</h3>

<p>
If the routing mode of the experiment is static, each Linktest node
pings the remainder of nodes in the experiment. If any node cannot be
reached, the Linktest node reports an error.
</p>


<a NAME="Level3"></a>
<li> <h3>Level 3 - Loss</h3>

<p>
Each Linktest node on a lan or direct link with loss > 0 sends a burst
of packets to the node on the other side of the link using Rude and
Crude, a real-time packet emitter and collector. If the percentage of
packets lost is outside the 99% confidence interval for
normally-distributed loss at that setting, Linktest reports an
error.
</p>


<a NAME="Level4"></a>
<li> <h3>Level 4 - Bandwidth</h3>

<p>
Each Linktest node on a lan or direct link uses iperf to measure the
bandwidth of the link, provided that the link is >= 1 Mbps and does
not have a link loss value. If the measured bandwidth is outside the
margin of error, Linktest reports an error.
The Bandwidth test adds up to 20 seconds per distinct link in the
experiment; 10 seconds in each direction. Linktest attempts to run
tests in parallel whenever 
possible, but topologies such as a star will lead to longer runtimes
since Linktest allows only one sender or receiver to run on a node at a
time.
</p>

<p>
<b>Note:</b> In an effort not to get bogged down by reporting too many
false positive errors, Linktest will look at the actual delta and
report an error only if the measured bandwidth is more then 5%
<em>below</em> the desired value, or more than 1% <em>above</em> the
desired value.
</p>

</ul>
<hr>
<a name="Advanced"></a>
<center>
<h2>Advanced Topics</h2>
</center>

<p>
To run Linktest after experiment swapin, you may use Emulab's Web
Interface, or you may manually invoke the script <tt>run_linktest.pl</tt> on
ops. You may also examine Linktest output in its log directory. Read
about these options in the following sections:
</p>
<p>
    <ul>
    <li> <a href="#Web">Running Linktest from the Web Interface</a>
    <li> <a href="#Ops">Running Linktest on Ops</a>
    <li> <a href="#Log">Linktest Log Directory</a>
    </ul>
</p>
<ul>
<a NAME="Web"></a>
<li> <h3>Running Linktest from the Web Interface</h3>
<p>
If you go to the "Show Experiment" page for your experiment, you will
see an option called "Run Linktest" in the auxiliary menu for the
experiment. Clicking on that link will take you to the run linktest
page, where you can select a level, and then start linktest running by
clicking on the Start button. Once linktest starts running, you can
stop it by clicking on the Stop button. Please be patient; linktest
can take a long time to run. Eventually, you will be notified of its
results in the window below the Start/Stop button. 
No email is sent.
</p>
<a NAME="Ops"></a>
<li> <h3>Running Linktest on Ops</h3>
<p>
Use run_linktest.pl to run Linktest on ops. The option "-e" is
mandatory for specifying the
project and experiment id. Running with "-q" will run all tests except
the bandwidth test. Running without "-q" runs all tests. Running with "-o" allows you to specify an output directory
for log messages. Invoke run_linktest.pl with no options for a help
message.
Example:
</p>
<p>
<code><pre>run_linktest.pl -e utahstud/simple -q -o /tmp/linktest.log</code></pre>
</p>
<p>You may also specify the test level using the "-l" option. Example:
</p>
<p>
<code><pre>run_linktest.pl -e utahstud/simple -l 1</code></pre>
</p>

<p>
After Linktest completes, run_linktest.pl prints out errors found
during the run, if any. For scripting, run_linktest.pl returns 0 if no
errors were found, or !0 if at least one error was found.
No email is sent.
</p>


<a NAME="Log"></a>
<li> <h3>Linktest Log Directory</h3>
<p>

Linktest logs the results and any error reports in the tbdata/linktest
directory for each experiment. By default this directory's path is
<tt>/proj/&lt;myproj&gt;/exp/&lt;myexpt&gt;/tbdata/linktest/</tt> .
</p>
</ul>
