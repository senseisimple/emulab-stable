<!--
   EMULAB-COPYRIGHT
   Copyright (c) 2004, 2006 University of Utah and the Flux Group.
   All rights reserved.
  -->
<center>
<h2>Emulab Tutorial - Using Wireless Networking</h2>
</center>

Some Emulab nodes contain 802.11 a/b/g wifi interfaces (Atheros 5212 chipset),
and are scattered around at various locations in a large building.  To find out where they
are located and what their node IDs are, see the <a
href=https://www.emulab.net/floormap.php3>wireless floormaps</a> page.
When you click on one of the colored dots, you will be taken to a page
describing the node and what type of interfaces the node has installed
in it.
<br>
<br>
In addition to the nodes deployed throughout the building, we've also
concentrated a subset of them in our machine room.  36 of the pc600s now have
802.11 a/b/g interfaces, also with the Atheros 5212 chipset.  Each has an
external antenna deployed on the backs of the racks containing the pc600s.  To
find out which nodes are where, look at <a
href="https://www.emulab.net/floormap.php3?building=MEB-MRC600">the floormaps
for this sub-cluster</a>.  For connectivity, antenna positions, and related
information, see the <a href="#envinfo">Environmental Information</a>
subsection of this document.

<br>
<br>
Before using a wireless network interface in an experiment,
please read the following
<b>Acceptable Use Policy</b> (AUP) regarding wireless interfaces.
By using our wireless nodes, you agree to be bound by this AUP.

<ul>
<li> <b>Receiving: </b>
     You may listen to and monitor anything you like.  If you happen
     to observe "private" information such as plaintext Web passwords,
     you will not exploit that information, and you will take
     care not to let it leak out publicly, e.g., in log files.
     </li><p>
     
<li> <b>Transmitting (1): </b>
     Do not transmit on channels that another experiment on the
     testbed is using, unless it's your own.  You can find out which
     channels are currently in use by looking at the top of the <a
     href=https://www.emulab.net/floormap.php3>wireless floormap</a>.
     <br>Where possible, choose channels that have the least frequency overlap
     with other experiments.  (channel/freq table coming.)
     </li><p>

<li> <b>Transmitting (2): </b>
     Do not flood a wireless network with non-responsive traffic for
     any significant period of time.  The following channels are
     "production networks" used by others at this location, so are
     more restricted. You may not send "large" amounts of traffic on
     them, and may send only low rates of non-responsive traffic.
     
     <table align=center border=2 cellpadding=0 cellspacing=2>
     <tr><th>Protocol</th><th>Channels</th></tr>
     <tr><td>A</td><td>36, 38, 45, 52, 56, 60, 64</td></tr>
     <tr><td>B/G</td><td>1, 3, 5, 6, 7, 9, 11</td></tr>
     </table>
     <p>

<li> <b>Question and Exceptions:</b> send to
     <a href="mailto:testbed-ops@flux.utah.edu">Testbed Ops</a>
     if you're not sure, or want an exception.

</ul>

<font size=+1>
Creating an Experiment with Wireless-Capable Nodes:</font>
<br>
<br>

To use a wireless network in an experiment, you must provide a few Emulab
specific NS directives in your NS file, which are illustrated in the
following small example:

	<code><pre>
	source tb_compat.tcl
	set ns [new Simulator]

	# Allocate the nodes.  Their "wifi-ness" is determined later,
	# by the type of networks you request to be set up on them.
	set nodew1 [$ns node]
	set nodew2 [$ns node]
	set nodew3 [$ns node]
	set node4  [$ns node]

	# A wireless lan connecting the first three nodes.
	set lan0 [$ns make-lan "$nodew1 $nodew2 $nodew3" 54Mb 0ms]

	# A regular duplex link from a wireless-capable node to a plain node.
	set link0 [$ns duplex-link $nodew1 $node4 100Mb 0ms DropTail]

	# Choose the wireless lan protocol.
	tb-set-lan-protocol $lan0 "80211g"

	# You must choose which node acts as the access point.
	tb-set-lan-accesspoint $lan0 $nodew1

	# Choose some other settings.
	tb-set-lan-setting $lan0 "channel" 2
	tb-set-node-lan-setting $lan0 $nodew1 "txpower" "auto"

	# Currently you must use Fedora Core 4 or Redhat 9.0 on wireless nodes.
	# Let the other node default to RHL-STD (currently 7.3).
	tb-set-node-os $nodew1 FC4-WIRELESS
	tb-set-node-os $nodew2 FC4-WIRELESS
	tb-set-node-os $nodew3 FC4-WIRELESS

	# Turn on static routing.
	$ns rtproto Static
	$ns run			</code></pre>

A few points should be noted:
<ul>
<li> <tt>lan0</tt> is created with standard <tt>make-lan</tt>
     directive, but with a bandwidth that reflects the typical speed of a
     wireless link (54Mb for 80211a and 80211g, 11Mb for 80211b). Note that
     you may not use duplex links of wireless interfaces; just lans.
     We assign each lan a unique ssid.

<li> After you create the lan, choose the <em>protocol</em> for the lan
     with the <tt>tb-set-lan-protocol</tt> directive. Currently, you can
     set the protocol to one of <tt>80211a, 80211b, or 80211g.</tt>. If you
     fail to set the protocol, the lan will consist of wired links, most
     likely with delay nodes inserted!

<li> <tt>link0</tt> is a plain duplex link. You may create plain links
     as long as the nodes have enough wired interfaces. If you try to
     create an experiment that uses more links (wired or wireless) on a
     node than are available in Emulab, the experiment will fail to map.
     Of the current 54 wifi nodes, the 18 pc3000w wifi nodes 
     (pcwf1-18) contain two wifi cards and one wired experimental interface 
     and the 36 pc600 (all pc600s except pc8,pc11,pc30,pc38) nodes contain one wifi card and four 
     experimental interfaces.

<li> In the example above, we let Emulab decide what wireless nodes to
     use for the lan. This is not an ideal approach, as Emulab does
     not currently track the connectivity of nodes, and so might pick
     a set of nodes (randomly) that cannot communicate with each
     other.  See the section below on <a href="#ChoosingNodes">choosing
     your nodes</a> for more information on how to overcome this
     problem.

<li> You must specify which node is to act as the <em>access point</em> for
     the lan.  Rather than using dedicated access points, Emulab's
     implementation of wireless lans uses the interface's capability to
     become an access point for a lan. The node that is chosen to be the
     access point should obviously be within range of all of the nodes in
     the lan. There is currently no automated mechanism to pick the access
     point for you, but one is planned for the future.
     <em>ad-hoc</em> mode is available in recent madwifi driver versions,
     including those installed on the <tt>FC4-WIRELESS</tt> image.  However, we
     haven't yet integrated it as an option for NS files.

<li> Wireless lans allow a number of configuration parameters to be
     specified, either for the lan as a whole, or for individual members of
     a lan. There are two Emulab specific directives that you can use;
     <tt>tb-set-lan-setting</tt> sets a configuration parameter for the
     entire lan. In the example above, we set the channel to be used for
     the lan to channel five. Per-node settings can be specified with the
     <tt>tb-set-node-lan-setting</tt> directive. In the example, we set the
     transmit power for <tt>nodew1</tt> to auto; all other nodes will
     default to an interface specific setting.

<li> You must use Fedora Core 4 or RedHat 9.0 to take advantage of wireless
     interfaces. Be sure to set the OSID for all of your wireless nodes to
     <tt>FC4-WIRELESS</tt> or <tt>RHL90-WIRELESS</tt>.  <tt>FC4-WIRELESS</tt>
     contains a 2.6.x kernel and very recent madwifi drivers; 
     <tt>RHL90-WIRELESS</tt> is contains a 2.4.x kernel and is outdated.

<li> The pc3000w wifi nodes contain <a
     href="http://netgear.com/products/details/WAG311.php">Netgear WAG311
     cards</a>, which use the Atheros 5212 802.11a/b/g chipset; 
     the pc600 nodes contain <a
     href="http://www.dlink.com/products/?sec=0&pid=306">D-Link DWL-AG530</a>,
     which also use the Atheros 5212 chipset.  This chipset is quite flexible
     since most of the 802.11 MAC layer is handled in software. Emulab
     provides the standard madwifi Atheros driver by default, but
     there are alternatives such as the madwifi stripped driver from
     the MIT roofnet project and SoftMAC from the Universtiy of
     Colorado at Boulder. Here are some useful links:
     <br>
     <a href="http://netgear.com/products/details/WAG311.php">
     Netgear WAG311 product info</a>
     <br>
     <a href="http://www.dlink.com/products/?sec=0&pid=306">
     D-Link DWL-AG530</a>
     <br>
     <a href="http://madwifi.sourceforge.net">Madwifi Atheros driver</a>
     <br>
     <a href="http://pdos.csail.mit.edu/~jbicket/madwifi.stripped/">
     Stripped madwifi driver</a> - <i>Primarily for use with
     <a href="http://pdos.csail.mit.edu/click/">click</a></i>

</ul>

Numerous interface settings are possible using <tt>tb-set-lan-setting</tt>
and <tt>tb-set-node-lan-setting</tt>. These mostly correspond to options
that are available using the <tt>iwconfig</tt> command on Fedora Core 4 or Redhat 9.0. Not
all options are accepted by all cards, and the format of the value you
provide for the option must be acceptable to iwconfig. At some point in the
future we hope to make this more explicit so that know exactly what options
are available each type of card, and what their legal values are. For now
you have to be something of an expert. Here is a rough guide to what you
can currently specify:

<ul>
<li> <tt>channel</tt> - Set the channel for the lan to either a
     channel number or a frequency. If you do not set the channel one
     will be choosen for you, and thats probably just as bad as
     setting it yourself without knowing what other people are using!

<li> <tt>rate</tt> - Some interfaces support setting a bit rate
     different then the default. The default is to tell the interface
     to use "auto" mode (varies the rate according to RF conditions),
     but you can specify a specific rate for either the entire lan or
     for just one node. The value should be in bits per second with no
     units (11000, 54000, etc). See the iwconfig man page for more
     details on the format of this option. 

<li> <tt>txpower</tt> - Some interfaces support setting the transmit
     power to something different then the default. The default is to
     tell the interface to use "auto" mode. See the iwconfig man page
     for more details on the format of this option. Not all interfaces
     support this option. 
     
<li> <tt>sensitivity</tt> - Some interfaces support setting the sensitivity
     to something different then the default. The default is to
     tell the interface to use "auto" mode. See the iwconfig man page
     for more details on the format of this option. Not all interfaces
     support this option. 
</ul>

After your experiment is swapped in, the above settings (including the
accesspoint) can be changed on the fly, using either the
<tt>link_config</tt> script on <tt>users.emulab.net</tt>, or with the
XMLRPC interface. For example, if you want to change the accesspoint
of a lan, first determine the MAC address (dotted or undotted notation
is fine) of the interface you want to be the accesspoint, and then use
link_config:

<code><pre>
	link_config myproj myexp lan0 accesspoint=00:09:5B:94:26:AF
</code></pre>

Or you can use the <a href=../xmlrpcapi.php3>XMLRPC interface</a> from
your desktop or from <tt>users</tt>.

<code><pre>
	sshxmlrpc_client.py link_config proj=myproj exp=myexp
		link=lan0 "params={'accesspoint': '00:09:5B:94:26:AF'}"
</code></pre>

You may also change the settings for an individual node in a wireless
lan (although in some cases this could make the lan unusable if you
were to change a setting on just a single node). To do this, use the
<tt>-s</tt> option to link_config or the <tt>src</tt> argument to the
XMLRPC interface:

<code><pre>
	link_config -s nodew1 myproj myexp lan0 txpower=50

	sshxmlrpc_client.py link_config proj=myproj exp=myexp
		src=nodew1 link=lan0 "params={'txpower': 50}"
</code></pre>

To <em>enable</em> and <em>disable</em> the interface for individual
nodes on the lan:

<code><pre>
	link_config -s nodew1 myproj myexp lan0 enable=no
	link_config -s nodew1 myproj myexp lan0 enable=yes

	sshxmlrpc_client.py link_config proj=myproj exp=myexp
		src=nodew1 link=lan0 "params={'enable': 'no'}"

Note this currently operates by bringing the interface up/down with
the <tt>ifconfig</tt> command. 
</code></pre>

<br>
<br>

<a NAME="ChoosingNodes"></a>
<font size=+1>
Choosing Physical Nodes:</font>
<br>
<br>

As mentioned above, Emulab's default mapping of nodes in your virtual
topology, to physical nodes with wireless interfaces, does not
currently take into account physical connectivity (walls, floors,
electrical conduits, etc. all conspire to make it possible that two
wireless nodes 50 feet apart from each other will not actually be able to
communicate with each other). We <b>are</b> planning to add this
capability in the future, but in the meantime it is mostly up to you
to choose nodes that make sense for your topology. You might end up
having to make some trial and error runs, trying to find the right
set of nodes (including setting the accesspoint to different nodes in
a lan) before you get a working set.

<br>
<br>
To assist in this chore there are two Emulab specific NS extensions
you can use in your NS file. The first approach is to use the
<tt>tb-use-physnaming</tt> extension.

	<code><pre>
	tb-use-physnaming 1
	
	set pc222 [$ns node]
	set pc223 [$ns node]
	set pc224 [$ns node] </code></pre>

which says that whenever a node is named by an existing physical node
in the testbed, do an implicit fix-node. This saves a little bit of
typing, and in some cases might be easier to manage then the second
approach, which is to use <tt>tb-fix-node</tt> for all (or some) of
the nodes in your lan. Using the
<a href=https://www.emulab.net/floormap.php3>wireless floormaps</a>
choose which nodes you want, and then in your NS file:

	<code><pre>
	set nodew1 [$ns node]
	set nodew2 [$ns node]
	set nodew3 [$ns node]

	tb-fix-node $nodew1 pc222
	tb-fix-node $nodew2 pc223
	tb-fix-node $nodew3 pc224 </code></pre>

Keep in mind that the physical nodes you choose must be free when you
swap in your experiment!

<br>
<br>

<a NAME="envinfo"></a>
<font size=+1>
Environment Information</font>
<br>
<br>

Due to the dense nature of the pc600 mini-cluster, we describe some of its
properties and deployment characteristics in detail in this section.  You can
view a map of the deployment 
<a href="https://www.emulab.net/floormap.php3?building=MEB-MRC600">here</a>.

<br>
<br>
The external antennas for each wireless interface in the pc600s are deployed in
a 6 x 6 grid on the back side of the racks housing the pc600s and pc850s.  Each
antenna is currently pointed straight down towards the floor.  The
grid is 300cm x 224cm.  All nodes in the grid are easily able to communicate
with each another; the interesting nature of this grid becomes more evident
when many nodes attempt to send packets at the same time.  Because the nodes
are deployed in our machine room, the environment is hostile, with many other
racks, machines, conduits, and other items, conspiring to provide various types
of signal interference.

<br>
<br>
To give you an idea of what you might expect when many nodes in proximity are
sending packets at the same time, we ran some simple tests.  In this
experiment, all nodes are placed in ad-hoc mode in a single LAN, and send
packets all at once to the broadcast address in their subnet.  Each node sends
1000 1024-byte packets at a rate of 10pps.  We then do this iteratively over
all channels in each of a, b, and g modes.  The results are presented in terms
of the percentage of broadcast packets received at each node.  The Aggregate
Statistics table simply aggregates all statistics gathered from each 802.11
mode across all receivers.

<br>
<br>
<center>
<table>
  <tr>
    <td colspan="6"><center>Aggregate Statistics</center></td>
  </tr>
  <tr>
    <td>Mode</td>
    <td>min</td>
    <td>mean</td>
    <td>max</td>
    <td>stddev</td>
    <td>var</td>
  </tr>

  <tr>
    <td>802.11 a</td>
    <td>0.10</td>
    <td>65.21</td>
    <td>99.40</td>
    <td>15.69</td>
    <td>246.27</td>
  </tr>
  <tr>
    <td>802.11 b</td>
    <td>2.10</td>
    <td>25.19</td>
    <td>91.10</td>
    <td>15.01</td>
    <td>225.25</td>
  </tr>
  <tr>
    <td>802.11 g</td>
    <td>0.30</td>
    <td>26.04</td>
    <td>83.10</td>
    <td>15.84</td>
    <td>250.99</td>
  </tr>
</table>
</center>

<!--
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
-->

